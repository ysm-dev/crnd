name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build binaries for all platforms
        run: |
          # Darwin
          bun build ./src/cli/main.ts --compile --target=bun-darwin-arm64 --outfile crnd-darwin-arm64
          bun build ./src/cli/main.ts --compile --target=bun-darwin-x64 --outfile crnd-darwin-x64

          # Linux (glibc)
          bun build ./src/cli/main.ts --compile --target=bun-linux-arm64 --outfile crnd-linux-arm64
          bun build ./src/cli/main.ts --compile --target=bun-linux-x64 --outfile crnd-linux-x64

          # Linux (musl)
          bun build ./src/cli/main.ts --compile --target=bun-linux-arm64-musl --outfile crnd-linux-arm64-musl
          bun build ./src/cli/main.ts --compile --target=bun-linux-x64-musl --outfile crnd-linux-x64-musl

          # Windows
          bun build ./src/cli/main.ts --compile --target=bun-windows-x64 --outfile crnd-windows-x64.exe

      - name: Generate packages
        run: bun run generate-packages

      - name: Create tarballs for GitHub Release
        run: |
          mkdir -p release

          # Darwin
          for arch in arm64 x64; do
            cp "crnd-darwin-${arch}" crnd
            tar -czvf "release/crnd-darwin-${arch}.tar.gz" crnd
            rm crnd
          done

          # Linux (glibc)
          for arch in arm64 x64; do
            cp "crnd-linux-${arch}" crnd
            tar -czvf "release/crnd-linux-${arch}.tar.gz" crnd
            rm crnd
          done

          # Linux (musl)
          for arch in arm64 x64; do
            cp "crnd-linux-${arch}-musl" crnd
            tar -czvf "release/crnd-linux-${arch}-musl.tar.gz" crnd
            rm crnd
          done

          # Windows
          cp crnd-windows-x64.exe crnd.exe
          zip -r "release/crnd-windows-x64.zip" crnd.exe
          rm crnd.exe

      - name: Setup npm authentication
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Publish platform packages
        run: |
          for pkg in packages/@crnd/cli-*; do
            echo "Publishing $pkg..."
            npm publish "$pkg" --access public
          done

      - name: Publish main package
        run: npm publish dist --access public

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            release/*

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          SHA_DARWIN_ARM64=$(sha256sum release/crnd-darwin-arm64.tar.gz | cut -d ' ' -f1)
          SHA_DARWIN_X64=$(sha256sum release/crnd-darwin-x64.tar.gz | cut -d ' ' -f1)
          SHA_LINUX_ARM64=$(sha256sum release/crnd-linux-arm64.tar.gz | cut -d ' ' -f1)
          SHA_LINUX_X64=$(sha256sum release/crnd-linux-x64.tar.gz | cut -d ' ' -f1)

          git clone https://x-access-token:${GH_TOKEN}@github.com/ysm-dev/homebrew-crnd.git /tmp/homebrew-crnd
          cd /tmp/homebrew-crnd

          cat > Formula/crnd.rb << EOF
          class Crnd < Formula
            desc "Agent-first CLI for cron scheduling and process management"
            homepage "https://github.com/ysm-dev/crnd"
            license "MIT"
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/ysm-dev/crnd/releases/download/v#{version}/crnd-darwin-arm64.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "https://github.com/ysm-dev/crnd/releases/download/v#{version}/crnd-darwin-x64.tar.gz"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/ysm-dev/crnd/releases/download/v#{version}/crnd-linux-arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "https://github.com/ysm-dev/crnd/releases/download/v#{version}/crnd-linux-x64.tar.gz"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              bin.install "crnd"
            end

            test do
              assert_match "crnd", shell_output("#{bin}/crnd --version")
            end
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/crnd.rb
          git commit -m "Update crnd to ${VERSION}"
          git push
